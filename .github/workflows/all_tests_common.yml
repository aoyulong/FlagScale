name: Common All Tests

on:
  workflow_call:
    inputs:
      hardware:
        required: true
        type: string
        description: Platform name (e.g., cuda, default)

jobs:
  checkout_and_config:
    runs-on: ubuntu-latest
    outputs:
      ci_image: ${{ steps.config.outputs.ci_image }}
      runs_on: ${{ steps.config.outputs.runs_on }}
      container_volumes: ${{ steps.config.outputs.container_volumes }}
      container_options: ${{ steps.config.outputs.container_options }}
      device_types: ${{ steps.config.outputs.device_types }}
      functional_test_matrix: ${{ steps.config.outputs.functional_test_matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          ssh-strict: true
          ssh-user: git
          persist-credentials: false
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          submodules: false
          set-safe-directory: true

      - name: Cache source code
        id: cache-source
        uses: actions/cache@v4
        with:
          path: .
          key: source-code-${{ github.sha }}

      - name: Create source code tarball for distribution
        run: |
          tar -czf /tmp/flagscale-source.tar.gz \
            --exclude='.git' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            .

      - name: Upload source code artifact
        uses: actions/upload-artifact@v4
        with:
          name: flagscale-source-${{ github.sha }}
          path: /tmp/flagscale-source.tar.gz
          retention-days: 1
          compression-level: 0

      - name: Load hardware configuration
        id: config
        run: |
          set -euo pipefail

          PLATFORM="${{ inputs.hardware }}"
          CONFIG_FILE=".github/configs/${PLATFORM}.yml"

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "❌ Error: Hardware configuration file not found: $CONFIG_FILE"
            echo "Available configs:"
            ls -la .github/configs/
            exit 1
          fi

          # Install mikefarah/yq (v4) for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.45.1/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          /usr/local/bin/yq --version

          # Extract CI/CD configuration from .github/configs
          CI_IMAGE=$(/usr/local/bin/yq -r '.ci_image' "$CONFIG_FILE")
          RUNNER_LABELS=$(/usr/local/bin/yq -o=json -I=0 '.runner_labels' "$CONFIG_FILE")
          VOLUMES=$(/usr/local/bin/yq -o=json -I=0 '.container_volumes' "$CONFIG_FILE")
          CONTAINER_OPTIONS=$(/usr/local/bin/yq -r '.container_options' "$CONFIG_FILE")

          # Validate required fields
          if [ -z "$CI_IMAGE" ] || [ "$CI_IMAGE" = "null" ]; then
            echo "❌ Error: ci_image not found in $CONFIG_FILE"
            exit 1
          fi
          if [ -z "$RUNNER_LABELS" ] || [ "$RUNNER_LABELS" = "null" ]; then
            echo "❌ Error: runner_labels not found in $CONFIG_FILE"
            exit 1
          fi

          # Query device types from test platform configuration
          echo "Querying device types for platform: $PLATFORM"
          DEVICE_TYPES=$(python tests/test_utils/runners/parse_config.py --platform "$PLATFORM" --type device_types 2>/dev/null || echo '[]')
          echo "Device types: $DEVICE_TYPES"

          # Discover functional test matrix (device/task/model/case combinations)
          echo "Discovering functional test matrix..."
          FUNCTIONAL_TEST_MATRIX="[]"

          # Parse functional tests from platform configuration for each device type
          if [ -f "tests/test_utils/runners/parse_config.py" ]; then
            FUNCTIONAL_TEST_MATRIX=$(echo "$DEVICE_TYPES" | jq -r '.[]' | while read device; do
              # Get functional tests for this device from platform config
              functional_json=$(python tests/test_utils/runners/parse_config.py \
                --platform "$PLATFORM" \
                --device "$device" \
                --type functional 2>/dev/null || echo '{}')

              # Convert the functional tests JSON to device/task/model/case matrix entries
              echo "$functional_json" | jq -r 'to_entries[] | .key as $task | .value | to_entries[] | .key as $model | .value[] | {device: "'"$device"'", task: $task, model: $model, case: .}'
            done | jq -s -c '.')
          fi
          echo "Functional test matrix: $FUNCTIONAL_TEST_MATRIX"

          echo "✅ Loaded config for platform: $PLATFORM"

          # Output values
          echo "ci_image=$CI_IMAGE" >> $GITHUB_OUTPUT
          echo "container_options=$CONTAINER_OPTIONS" >> $GITHUB_OUTPUT

          { echo 'runs_on<<EOFRUNSON'; echo "$RUNNER_LABELS"; echo 'EOFRUNSON'; } >> $GITHUB_OUTPUT
          { echo 'container_volumes<<EOFVOLUMES'; echo "$VOLUMES"; echo 'EOFVOLUMES'; } >> $GITHUB_OUTPUT
          { echo 'device_types<<EOFDEVICETYPES'; echo "$DEVICE_TYPES"; echo 'EOFDEVICETYPES'; } >> $GITHUB_OUTPUT
          { echo 'functional_test_matrix<<EOFFUNCTIONAL'; echo "$FUNCTIONAL_TEST_MATRIX"; echo 'EOFFUNCTIONAL'; } >> $GITHUB_OUTPUT

  unit_tests:
    needs: checkout_and_config
    strategy:
      fail-fast: false
      matrix:
        device: ${{ fromJson(needs.checkout_and_config.outputs.device_types) }}
    uses: ./.github/workflows/unit_tests_common.yml
    name: unit_tests
    with:
      platform: ${{ inputs.hardware }}
      device: ${{ matrix.device }}
      image: ${{ needs.checkout_and_config.outputs.ci_image }}
      runs_on: ${{ needs.checkout_and_config.outputs.runs_on }}
      container_volumes: ${{ needs.checkout_and_config.outputs.container_volumes }}
      container_options: ${{ needs.checkout_and_config.outputs.container_options }}
      source_artifact: flagscale-source-${{ github.sha }}

  functional_tests:
    needs:
      - checkout_and_config
      - unit_tests
    strategy:
      fail-fast: false
      matrix:
        test_config: ${{ fromJson(needs.checkout_and_config.outputs.functional_test_matrix) }}
    uses: ./.github/workflows/functional_tests_common.yml
    with:
      platform: ${{ inputs.hardware }}
      device: ${{ matrix.test_config.device }}
      task: ${{ matrix.test_config.task }}
      model: ${{ matrix.test_config.model }}
      case: ${{ matrix.test_config.case }}
      image: ${{ needs.checkout_and_config.outputs.ci_image }}
      runs_on: ${{ needs.checkout_and_config.outputs.runs_on }}
      container_volumes: ${{ needs.checkout_and_config.outputs.container_volumes }}
      container_options: ${{ needs.checkout_and_config.outputs.container_options }}
      source_artifact: flagscale-source-${{ github.sha }}

  all_tests_complete:
    needs:
      - checkout_and_config
      - unit_tests
      - functional_tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Verify all tests passed
        run: |
          if [ "${{ needs.unit_tests.result }}" != "success" ] || \
             [ "${{ needs.functional_tests.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          fi
          echo "✅ All tests completed successfully!"
